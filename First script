/**
 * Demand Gen Call Center Controller
 * –¢–æ–ª—å–∫–æ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
 * –°—Ç—Ä–∞–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏
 * –û–∫–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∏–∑ MSK –≤ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∞–∫–∫–∞—É–Ω—Ç–∞ —Å —É—á—ë—Ç–æ–º DST
 */

// ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====
const CONFIG = {
  tgBotToken: "YOUR_BOT_TOKEN_HERE",
  tgChatId: "YOUR_CHAT_ID_HERE",
  baseTimezone: "Europe/Moscow",
  
  // –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–¥–æ–≤ —Å—Ç—Ä–∞–Ω –Ω–∞ –ø–æ–ª–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
  countryMap: {
    "1015": "Canada",
    "2840": "United States",
    "2356": "India",
    "2410": "South Korea",
    "2826": "United Kingdom",
    "2250": "France",
    "2276": "Germany",
    "2124": "Australia",
    "2392": "Japan",
    "2504": "Spain",
    "2380": "Italy",
    "2528": "Netherlands",
    "2372": "Ireland",
    "2756": "Switzerland",
    "2036": "Austria",
    "2578": "Belgium",
    "2620": "Portugal",
    "2703": "Czech Republic",
    "2616": "Poland",
    "2752": "Sweden",
    "2208": "Denmark",
    "2233": "Estonia",
    "2440": "Lithuania",
    "2643": "Russian Federation",
    "2702": "Singapore",
    "2158": "Taiwan",
    "2360": "Indonesia",
    "2458": "Malaysia",
    "2608": "Philippines",
    "2764": "Thailand",
    "2704": "Vietnam",
    "2344": "Hong Kong",
    "2156": "China",
    "2554": "New Zealand",
    "2484": "Mexico",
    "2170": "Colombia",
    "2076": "Brazil",
    "2578": "Sweden",
    "2246": "Finland",
    "2578": "Norway"
  },

  // –û–∫–Ω–∞ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º (–≤ MSK - Europe/Moscow)
  windows: {
    "Japan": { startH: 23, startM: 0, endH: 16, endM: 0 },
    "South Korea": { startH: 23, startM: 0, endH: 17, endM: 0 },
    "Australia": { startH: 0, startM: 0, endH: 13, endM: 0 },
    "Singapore": { startH: 2, startM: 0, endH: 19, endM: 0 },
    "Malaysia": { startH: 23, startM: 0, endH: 19, endM: 0 },
    "France": { startH: 8, startM: 0, endH: 22, endM: 0 },
    "United Kingdom": { startH: 8, startM: 0, endH: 22, endM: 0 },
    "Austria": { startH: 9, startM: 0, endH: 21, endM: 0 },
    "Italy": { startH: 8, startM: 0, endH: 21, endM: 0 },
    "Portugal": { startH: 9, startM: 0, endH: 23, endM: 0 },
    "Spain": { startH: 8, startM: 0, endH: 22, endM: 0 },
    "Netherlands": { startH: 10, startM: 0, endH: 22, endM: 0 },
    "Norway": { startH: 9, startM: 0, endH: 23, endM: 0 },
    "Sweden": { startH: 9, startM: 0, endH: 22, endM: 0 },
    "Denmark": { startH: 9, startM: 0, endH: 21, endM: 0 },
    "Finland": { startH: 9, startM: 0, endH: 23, endM: 0 },
    "Canada": { startH: 15, startM: 0, endH: 4, endM: 0 },
    "Mexico": { startH: 15, startM: 0, endH: 2, endM: 0 },
    "Colombia": { startH: 12, startM: 0, endH: 2, endM: 0 },
    "Brazil": { startH: 15, startM: 0, endH: 2, endM: 0 },
    "India": { startH: 17, startM: 30, endH: 6, endM: 30 },
    "United States": { startH: 15, startM: 0, endH: 4, endM: 0 },
    "Germany": { startH: 9, startM: 0, endH: 21, endM: 0 },
    "Belgium": { startH: 9, startM: 0, endH: 22, endM: 0 },
    "Poland": { startH: 9, startM: 0, endH: 21, endM: 0 },
    "Czech Republic": { startH: 9, startM: 0, endH: 21, endM: 0 },
    "Ireland": { startH: 8, startM: 0, endH: 22, endM: 0 },
    "Switzerland": { startH: 9, startM: 0, endH: 21, endM: 0 },
    "Estonia": { startH: 9, startM: 0, endH: 21, endM: 0 },
    "Lithuania": { startH: 9, startM: 0, endH: 21, endM: 0 },
    "Russian Federation": { startH: 15, startM: 0, endH: 4, endM: 0 },
    "Taiwan": { startH: 23, startM: 0, endH: 17, endM: 0 },
    "Indonesia": { startH: 2, startM: 0, endH: 19, endM: 0 },
    "Philippines": { startH: 0, startM: 0, endH: 16, endM: 0 },
    "Thailand": { startH: 1, startM: 0, endH: 18, endM: 0 },
    "Vietnam": { startH: 0, startM: 0, endH: 17, endM: 0 },
    "Hong Kong": { startH: 0, startM: 0, endH: 17, endM: 0 },
    "China": { startH: 0, startM: 0, endH: 17, endM: 0 },
    "New Zealand": { startH: 1, startM: 0, endH: 14, endM: 0 }
  }
};

// ===== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø =====

function main() {
  try {
    validateConfig_();

    const account = AdsApp.currentAccount();
    const tz = account.getTimeZone();
    const rawId = account.getCustomerId();
    const accountId = formatCustomerId_(rawId);

    // –í—ã—Ç—è–≥–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω—É –∏–∑ —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏
    const country = getCountryFromCampaign_();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞
    checkAccountStatusAndAlert_(rawId, accountId, tz);

    // –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã
    const baseWindow = CONFIG.windows[country];
    if (!baseWindow) {
      Logger.log(`No window configured for country: ${country}`);
      tgOncePerHour_(
        `no_window_${rawId}`,
        `üìå <b>${country}</b>\n\n` +
        `‚ö†Ô∏è NO WINDOW CONFIGURED\n` +
        `Account ID: <b>${accountId}</b>\n` +
        `Country: ${country} not found in CONFIG.windows`
      );
      return;
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–∫–Ω–æ –∏–∑ MSK –≤ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∞–∫–∫–∞—É–Ω—Ç–∞
    const convertedWindow = convertWindowToTimezone_(baseWindow, CONFIG.baseTimezone, tz);
    const inWindow = isInWindow_(convertedWindow.startH, convertedWindow.startM, convertedWindow.endH, convertedWindow.endM, tz);

    // –ò—â–µ–º Demand Gen –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
    const rows = AdsApp.search(`
      SELECT
        ad_group_ad.resource_name,
        ad_group_ad.status
      FROM ad_group_ad
      WHERE campaign.advertising_channel_type = 'DEMAND_GEN'
        AND ad_group_ad.status != 'REMOVED'
    `);

    const ads = [];
    while (rows.hasNext()) {
      ads.push(rows.next());
      if (ads.length > 2) break;
    }

    // Safety check
    if (ads.length !== 1) {
      tgOncePerHour_(
        `safety_${rawId}`,
        `üìå <b>${country}</b>\n\n` +
        `üö® SAFETY STOP\n` +
        `Account ID: <b>${accountId}</b>\n` +
        `Found Demand Gen ads: ${ads.length}\n` +
        `Action: NONE`
      );
      return;
    }

    const ad = ads[0];
    const current = ad.adGroupAd.status;
    const desired = inWindow ? "ENABLED" : "PAUSED";

    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è
    if (current !== desired) {
      AdsApp.mutate({
        adGroupAdOperation: {
          update: {
            resourceName: ad.adGroupAd.resourceName,
            status: desired
          },
          updateMask: "status"
        }
      });

      const stats = getStats_(["TODAY", "LIFETIME"]);
      const nowStr = Utilities.formatDate(new Date(), tz, "yyyy-MM-dd HH:mm");
      const currency = account.getCurrencyCode();
      const exchangeRate = getExchangeRate_(currency);

      tgSend_(
        `üìå <b>${country}</b>\n\n` +
        `${desired === "ENABLED" ? "üü¢ ON" : "üî¥ OFF"} Demand Gen\n` +
        `Account ID: <b>${accountId}</b>\n` +
        `Time: ${nowStr} (${tz})\n` +
        `Window: ${fmtWindow_(convertedWindow)} (${tz})\n` +
        `Status: ${current} ‚Üí ${desired}\n\n` +
        `üìä TODAY\n` +
        `Spend: ${stats.TODAY.cost.toFixed(2)} ${currency} (${formatUSD_(stats.TODAY.cost, exchangeRate)})\n` +
        `Clicks: ${stats.TODAY.clicks}\n` +
        `Leads: ${stats.TODAY.conv}\n` +
        `Cost/Lead: ${formatUSD_(stats.TODAY.conv > 0 ? stats.TODAY.cost / stats.TODAY.conv : 0, exchangeRate)}\n\n` +
        `üìà LIFETIME\n` +
        `Spend: ${stats.LIFETIME.cost.toFixed(2)} ${currency} (${formatUSD_(stats.LIFETIME.cost, exchangeRate)})\n` +
        `Clicks: ${stats.LIFETIME.clicks}\n` +
        `Leads: ${stats.LIFETIME.conv}\n` +
        `Cost/Lead: ${formatUSD_(stats.LIFETIME.conv > 0 ? stats.LIFETIME.cost / stats.LIFETIME.conv : 0, exchangeRate)}`
      );
    }

  } catch (e) {
    tgSend_(
      `üìå <b>Unknown</b>\n\n` +
      `‚ùå ERROR\n` +
      `Error: ${e.toString()}\n` +
      `Time: ${new Date().toString()}`,
      true
    );
  }
}

// ===== –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –û–ö–ù–ê –ú–ï–ñ–î–£ –ß–ê–°–û–í–´–ú–ò –ü–û–Ø–°–ê–ú–ò =====

function convertWindowToTimezone_(baseWindow, fromTz, toTz) {
  try {
    const now = new Date();

    // –ü–æ–ª—É—á–∞–µ–º —Å–º–µ—â–µ–Ω–∏—è —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ (—É—á–∏—Ç—ã–≤–∞–µ—Ç DST)
    const fromOffset = getTimezoneOffset_(now, fromTz);
    const toOffset = getTimezoneOffset_(now, toTz);
    
    // –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö
    const offsetDiff = toOffset - fromOffset;

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞
    let startMins = baseWindow.startH * 60 + baseWindow.startM + offsetDiff;
    let endMins = baseWindow.endH * 60 + baseWindow.endM + offsetDiff;

    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤—Ä–µ–º—è
    startMins = normalizeTime_(startMins);
    endMins = normalizeTime_(endMins);

    return {
      startH: Math.floor(startMins / 60),
      startM: startMins % 60,
      endH: Math.floor(endMins / 60),
      endM: endMins % 60
    };
  } catch (e) {
    Logger.log(`Error converting window: ${e.toString()}`);
    return baseWindow;
  }
}

function getTimezoneOffset_(date, tz) {
  try {
    // –§–æ—Ä–º–∞—Ç–∏ÔøΩÔøΩ—É–µ–º –¥–∞—Ç—É –≤ —Ü–µ–ª–µ–≤–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
    const formatter = Intl.DateTimeFormat('en-US', {
      timeZone: tz,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });

    const parts = formatter.formatToParts(date);
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∞—Å—Ç–∏ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏
    let year, month, day, hour, minute, second;
    for (const part of parts) {
      switch (part.type) {
        case 'year': year = parseInt(part.value); break;
        case 'month': month = parseInt(part.value) - 1; break;
        case 'day': day = parseInt(part.value); break;
        case 'hour': hour = parseInt(part.value); break;
        case 'minute': minute = parseInt(part.value); break;
        case 'second': second = parseInt(part.value); break;
      }
    }

    const tzDate = new Date(year, month, day, hour, minute, second);
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤ –º–∏–Ω—É—Ç–∞—Ö
    const diff = date.getTime() - tzDate.getTime();
    return -diff / (1000 * 60);
  } catch (e) {
    Logger.log(`Error getting timezone offset: ${e.toString()}`);
    return 0;
  }
}

function normalizeTime_(mins) {
  // –ü—Ä–∏–≤–æ–¥–∏–º –≤—Ä–µ–º—è –∫ —Ñ–æ—Ä–º–∞—Ç—É 0-1439 (0:00 - 23:59)
  mins = Math.floor(mins);
  
  if (mins < 0) {
    mins = ((mins % 1440) + 1440) % 1440;
  } else if (mins >= 1440) {
    mins = mins % 1440;
  }
  
  return mins;
}

// ===== –í–´–¢–Ø–ì–ò–í–ê–ù–ò–ï –°–¢–†–ê–ù–´ –ò–ó –¢–ê–†–ì–ï–¢–ò–†–û–í–ê–ù–ò–Ø =====

function getCountryFromCampaign_() {
  try {
    const rows = AdsApp.search(`
      SELECT
        campaign_criterion.location.geo_target_constant
      FROM campaign_criterion
      WHERE campaign.advertising_channel_type = 'DEMAND_GEN'
        AND campaign_criterion.type = 'LOCATION'
      LIMIT 1
    `);

    if (rows.hasNext()) {
      const geoCode = rows.next().campaignCriterion.location.geoTargetConstant;
      const country = CONFIG.countryMap[geoCode];
      
      if (country) {
        Logger.log(`Country detected: ${country}`);
        return country;
      }
    }
  } catch (e) {
    Logger.log("Failed to get country from campaign: " + e.toString());
  }

  return "Unknown";
}

// ===== –í–ê–õ–ò–î–ê–¶–ò–Ø =====

function validateConfig_() {
  if (!CONFIG.tgBotToken || CONFIG.tgBotToken === "YOUR_BOT_TOKEN_HERE") {
    throw new Error("Configure CONFIG.tgBotToken");
  }
  if (!CONFIG.tgChatId || CONFIG.tgChatId === "YOUR_CHAT_ID_HERE") {
    throw new Error("Configure CONFIG.tgChatId");
  }
}

// ===== –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ê–ö–ö–ê–£–ù–¢–ê =====

function checkAccountStatusAndAlert_(rawId, formattedId, tz) {
  try {
    const r = AdsApp.search(`
      SELECT
        customer.status
      FROM customer
      LIMIT 1
    `);

    if (!r.hasNext()) return;

    const status = r.next().customer.status;

    if (status && status !== "ENABLED") {
      const stats = getStats_(["TODAY", "LIFETIME"]);
      const reason = explainStatusBestEffort_(status);
      const currency = AdsApp.currentAccount().getCurrencyCode();
      const exchangeRate = getExchangeRate_(currency);
      const country = getCountryFromCampaign_();

      tgOncePerHour_(
        `ban_${rawId}`,
        `üìå <b>${country}</b>\n\n` +
        `üö´ ACCOUNT ISSUE DETECTED\n` +
        `Account ID: <b>${formattedId}</b>\n` +
        `Status: ${status}\n` +
        `Reason: ${reason}\n\n` +
        `üìä TODAY\n` +
        `Spend: ${stats.TODAY.cost.toFixed(2)} ${currency} (${formatUSD_(stats.TODAY.cost, exchangeRate)})\n` +
        `Clicks: ${stats.TODAY.clicks}\n` +
        `Leads: ${stats.TODAY.conv}\n` +
        `Cost/Lead: ${formatUSD_(stats.TODAY.conv > 0 ? stats.TODAY.cost / stats.TODAY.conv : 0, exchangeRate)}\n\n` +
        `üìà LIFETIME\n` +
        `Spend: ${stats.LIFETIME.cost.toFixed(2)} ${currency} (${formatUSD_(stats.LIFETIME.cost, exchangeRate)})\n` +
        `Clicks: ${stats.LIFETIME.clicks}\n` +
        `Leads: ${stats.LIFETIME.conv}\n` +
        `Cost/Lead: ${formatUSD_(stats.LIFETIME.conv > 0 ? stats.LIFETIME.cost / stats.LIFETIME.conv : 0, exchangeRate)}`
      );
    }
  } catch (e) {
    Logger.log("Error checking account status: " + e.toString());
  }
}

function explainStatusBestEffort_(status) {
  if (status === "SUSPENDED") return "Suspended by Google (check policy/billing/security in UI/email).";
  if (status === "CLOSED") return "Closed account (check UI/email).";
  if (status === "CANCELED") return "Canceled account (check UI/email).";
  return "Non-enabled status (check UI/email).";
}

// ===== –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –í–ê–õ–Æ–¢ =====

function getExchangeRate_(currency) {
  const rates = {
    INR: 0.012,
    KRW: 0.00075,
    CAD: 0.74,
    MXN: 0.058,
    COP: 0.00025,
    BRL: 0.20,
    EUR: 1.08,
    GBP: 1.27,
    JPY: 0.0067,
    AUD: 0.66,
    SGD: 0.74,
    MYR: 0.20,
    SEK: 0.093,
    NOK: 0.094,
    DKK: 0.145,
    CHF: 1.12,
    CZK: 0.042,
    PLN: 0.25,
    HKD: 0.128,
    CNY: 0.138,
    TWD: 0.031,
    IDR: 0.000063,
    PHP: 0.018,
    THB: 0.029,
    VND: 0.000039,
    NZD: 0.61
  };

  if (rates[currency]) {
    return rates[currency];
  }

  try {
    const response = UrlFetchApp.fetch(
      `https://api.exchangerate-api.com/v4/latest/${currency}`,
      { muteHttpExceptions: true }
    );

    if (response.getResponseCode() === 200) {
      const data = JSON.parse(response.getContentText());
      const rate = data.rates.USD;

      const props = PropertiesService.getScriptProperties();
      props.setProperty(`rate_${currency}`, rate.toString());

      Logger.log(`Exchange rate updated for ${currency}: 1 = ${rate} USD`);
      return rate;
    }
  } catch (e) {
    Logger.log(`Failed to fetch exchange rate: ${e.toString()}`);
  }

  const props = PropertiesService.getScriptProperties();
  const cachedRate = props.getProperty(`rate_${currency}`);
  if (cachedRate) {
    return parseFloat(cachedRate);
  }

  return 1;
}

function convertToUSD_(amount, rate) {
  return amount * rate;
}

function formatUSD_(amount, rate) {
  const usd = convertToUSD_(amount, rate);
  return `$${usd.toFixed(2)} USD`;
}

// ===== –ü–†–û–í–ï–†–ö–ê –í–†–ï–ú–ï–ù–ò =====

function isInWindow_(sh, sm, eh, em, tz) {
  const hh = Number(Utilities.formatDate(new Date(), tz, "HH"));
  const mm = Number(Utilities.formatDate(new Date(), tz, "mm"));

  const now = hh * 60 + mm;
  const start = sh * 60 + sm;
  const end = eh * 60 + em;

  return start < end
    ? now >= start && now < end
    : now >= start || now < end;
}

function fmtWindow_(w) {
  return `${pad2_(w.startH)}:${pad2_(w.startM)}‚Äì${pad2_(w.endH)}:${pad2_(w.endM)}`;
}

function pad2_(n) {
  return String(n).padStart(2, "0");
}

function formatCustomerId_(id) {
  if (!id) return "unknown";
  if (id.includes("-")) return id;
  if (id.length === 10) return id.replace(/^(\d{3})(\d{3})(\d{4})$/, "$1-$2-$3");
  return id;
}

// ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê =====

function getStats_(ranges) {
  const currency = AdsApp.currentAccount().getCurrencyCode();
  const out = { currency };

  for (const range of ranges) {
    const rows = AdsApp.search(`
      SELECT
        metrics.cost_micros,
        metrics.clicks,
        metrics.conversions
      FROM campaign
      WHERE ${range === "LIFETIME" ? "TRUE" : `segments.date DURING ${range}`}
    `);

    let cost = 0, clicks = 0, conv = 0;
    while (rows.hasNext()) {
      const r = rows.next();
      cost += Number(r.metrics.costMicros || 0);
      clicks += Number(r.metrics.clicks || 0);
      conv += Number(r.metrics.conversions || 0);
    }

    out[range] = { cost: cost / 1e6, clicks, conv };
  }

  return out;
}

// ===== TELEGRAM =====

function tgSend_(text, isHtml = true) {
  try {
    UrlFetchApp.fetch(`https://api.telegram.org/bot${CONFIG.tgBotToken}/sendMessage`, {
      method: "post",
      contentType: "application/json",
      payload: JSON.stringify({
        chat_id: CONFIG.tgChatId,
        text: text,
        parse_mode: isHtml ? "HTML" : "Markdown",
        disable_web_page_preview: true
      }),
      muteHttpExceptions: true
    });
  } catch (e) {
    Logger.log("Error sending Telegram message: " + e.toString());
  }
}

function tgOncePerHour_(key, text) {
  const props = PropertiesService.getScriptProperties();
  const tz = AdsApp.currentAccount().getTimeZone();
  const hour = Utilities.formatDate(new Date(), tz, "yyyy-MM-dd_HH");
  const k = `tg_hour_${key}_${hour}`;

  if (props.getProperty(k)) return;

  props.setProperty(k, "1");
  tgSend_(text);
}
